# Game Server

This project implements a WebSocket-based game server that handles real-time multiplayer game interactions.

## Overview

The server is built using WebSocket technology to provide bidirectional communication between the game clients and the server. It manages game state, player connections, and real-time updates.

## Features

- Real-time WebSocket communication
- Player connection management
- Game state synchronization
- Secure WebSocket implementation
- Inventory management (pull, move, discard items)
- Item ownership tracking and history

## Technical Details

The server is implemented in TypeScript using the WebSocket protocol. It handles:

- Connection establishment and management
- Player authentication and session handling
- Real-time game state updates
- Error handling and connection recovery
- Item lifecycle management (creation, updates, movement between locations)
- Item ownership history tracking

## Getting Started

1. Install dependencies:
```bash
npm install
```

2. Start the server:
```bash
npm start
```

The WebSocket server will start listening for connections on the configured port.

## Configuration

The server can be configured through environment variables:
- `PORT`: The port number for the WebSocket server (default: 8080)

## Security

The server implements standard WebSocket security practices including:
- Connection validation
- Input sanitization
- Rate limiting

## Error Handling

The server includes robust error handling for:
- Connection failures
- Invalid messages
- Protocol errors
- Resource cleanup on disconnection

## API Messages

### Discard Item

**Request:**
```json
{
  "type": "discard-item",
  "body": {
    "itemId": "string"
  }
}
```

**Response (Success):**
```json
{
  "type": "item-discarded",
  "body": {
    "itemId": "string"
  }
}
```

**Response (Error):**
```json
{
  "type": "error",
  "body": "Error message"
}
```

When an item is discarded, the server tracks the last owner of the item, allowing for potential item recycling and ownership history.

### Pull Item

**Request:**
```json
{
  "type": "pull-item"
}
```

**Response (Success - Recycled Item):**
```json
{
  "type": "pulled-item",
  "body": {
    "story": "You found a discarded item and restored it to working condition.",
    "item": { /* item object */ }
  }
}
```

**Response (Success - New Item):**
```json
{
  "type": "pulled-item",
  "body": {
    "story": "Generated story about the item",
    "item": { /* item object */ }
  }
}
```

**Response (Error):**
```json
{
  "type": "error",
  "body": "Error message"
}
```

The pull-item handler first attempts to find a discarded item that wasn't previously owned by the current user. If found, it moves the item to the user's inventory. If no suitable discarded item is found, it generates a new item using the LLM. The system will try up to 5 times to find a suitable discarded item before generating a new one, to account for potential skips due to ownership history.

## Item Lifecycle

Items in the game follow a lifecycle:

1. **Creation**: Items are either generated by the LLM or recycled from the discard pile
2. **Ownership**: Items are assigned to a player's inventory
3. **Usage**: Items have skills that can be used on other items
4. **Discarding**: Items can be discarded, which marks them with their last owner
5. **Recycling**: Discarded items can be found by other players (but not by their previous owner)

The recycling system is designed to prevent players from repeatedly discarding and retrieving the same items. When a player discards an item, it's marked with their user ID in the `lastOwner` field. When pulling items from the dispenser, the system first tries to find discarded items. If a discarded item's `lastOwner` matches the current user's ID, that item is skipped, and the system tries to find another one. This ensures that players can't exploit the system by repeatedly discarding and retrieving the same items, while also encouraging item circulation among different players. The more users a server has and the more discarded items from different users, the less likely a player will encounter this ownership restriction.

The `updateItem` function allows for modifying item properties while automatically preserving critical fields like ID, userId, and creation timestamp. This is implemented through the update expression logic, which skips these fields when building the update expression. This approach is used when tracking ownership history through the `lastOwner` field.

